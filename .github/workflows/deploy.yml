name: Deploy Backend (rsync + systemd)

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

env:
  SSH_HOST: ${{ vars.SSH_HOST }}
  SSH_PORT: ${{ vars.SSH_PORT }}
  SSH_USER: ${{ vars.SSH_USER }}
  SERVICE_NAME: ${{ vars.SERVICE_NAME }}
  RSYNC_SRC: ${{ vars.RSYNC_SRC }}
  RSYNC_DEST: ${{ vars.RSYNC_DEST }}
  HEALTH_URL: ${{ vars.HEALTH_URL }} # e.g. https://predictpix.com/api/health

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust server host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 10 -p "${SSH_PORT:-22}" "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Ensure destination directory exists
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "mkdir -p '${RSYNC_DEST%/}'"

      - name: Rsync backend to server
        run: |
          rsync -az --delete --omit-dir-times --no-perms --no-owner --no-group \
            --exclude=".git/" --exclude=".github/" --exclude="__pycache__/" \
            -e "ssh -p ${SSH_PORT:-22}" \
            "${RSYNC_SRC%/}/" "${SSH_USER}@${SSH_HOST}:${RSYNC_DEST%/}/"

      - name: Mark deploy time
        run: |
          date -u +%FT%TZ | ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "cat > '${RSYNC_DEST%/}/.deployed-at'"

      - name: Write commit SHA marker
        run: |
          echo "${GITHUB_SHA}" | ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "cat > '${RSYNC_DEST%/}/.deployed-sha'"

      - name: Restart service
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "sudo /usr/bin/systemctl restart '${SERVICE_NAME}' && sudo /usr/bin/systemctl is-active '${SERVICE_NAME}'"

      - name: Health check (public, retry with pipefail)
        shell: bash
        run: |
          set -Eeuo pipefail
          url="${HEALTH_URL:-https://predictpix.com/api/health}"
          echo "Polling $url until HTTP 200…"
          for i in {1..24}; do
            code=$(curl -fsS -o /dev/null -w '%{http_code}' "$url" || true)
            if [ "$code" = "200" ]; then
              curl -fsS "$url" | head -c 200
              exit 0
            fi
            echo "Health not ready (HTTP $code). Retry $i/24…"
            sleep 5
          done
          echo "Health check failed after retries."
          exit 1

      # ---- NEW: tooling for JSON parsing ----
      - name: Install jq (for JSON parsing)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # ---- NEW: derive login/markets endpoints from HEALTH_URL ----
      - name: Compute endpoints from HEALTH_URL
        id: endpoints
        shell: bash
        run: |
          set -Eeuo pipefail
          base="${HEALTH_URL%/api/health}"
          login_url="${base}/api/auth/login"
          markets_url="${base}/api/markets?limit=1"
          echo "login_url=${login_url}"   >> "$GITHUB_OUTPUT"
          echo "markets_url=${markets_url}" >> "$GITHUB_OUTPUT"
          echo "Using base: ${base}"
          echo "Login URL: ${login_url}"
          echo "Markets URL: ${markets_url}"

      # ---- NEW: sanity login using CI_API_KEY secret ----
      - name: Login (API key mode)
        id: login
        shell: bash
        env:
          LOGIN_URL: ${{ steps.endpoints.outputs.login_url }}
          CI_API_KEY: ${{ secrets.CI_API_KEY }}
        run: |
          set -Eeuo pipefail
          if [ -z "${CI_API_KEY:-}" ]; then
            echo "Missing secrets.CI_API_KEY"
            exit 1
          fi
          status=$(curl -sS -o login.json -w "%{http_code}" -X POST "$LOGIN_URL" \
            -H "Content-Type: application/json" \
            -d "{\"api_key\":\"${CI_API_KEY}\"}")
          echo "Login HTTP status: $status"
          test "$status" = "200"
          cat login.json
          token=$(jq -r '.access_token' login.json)
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            echo "No access_token in login response"; exit 1
          fi
          echo "token=$token" >> "$GITHUB_OUTPUT"

      # ---- NEW: authorized markets probe ----
      - name: Markets sanity (authorized)
        shell: bash
        env:
          MARKETS_URL: ${{ steps.endpoints.outputs.markets_url }}
          TOKEN: ${{ steps.login.outputs.token }}
        run: |
          set -Eeuo pipefail
          curl -fsS "${MARKETS_URL}" -H "Authorization: Bearer ${TOKEN}" | head -c 200
